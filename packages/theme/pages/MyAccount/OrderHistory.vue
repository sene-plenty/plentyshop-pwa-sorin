<template>
  <SfTabs :open-tab="1">
    <SfTab :title="$t('OrderHistory.My orders')">
      <div v-if="currentOrder">
        <SfButton
          class="sf-button--text all-orders"
          @click="(currentOrder = null), (returnOrder = false)"
        >
          {{ $t('OrderHistory.All orders') }}
        </SfButton>
        <div class="highlighted highlighted--total">
          <SfProperty
            name="Order ID"
            :value="orderGetters.getId(currentOrder)"
            class="sf-property--full-width property"
          />
          <SfProperty
            name="Date"
            :value="orderGetters.getDate(currentOrder)"
            class="sf-property--full-width property"
          />
          <SfProperty
            name="Status"
            :value="orderGetters.getStatus(currentOrder)"
            class="sf-property--full-width property"
          />
          <SfProperty
            name="Shipping"
            :value="$n(orderGetters.getShippingCost(currentOrder), 'currency')"
            class="sf-property--full-width property"
          />
          <SfProperty
            name="Total"
            :value="$n(orderGetters.getPrice(currentOrder), 'currency')"
            class="sf-property--full-width property"
          />
        </div>
        <SfTable class="products">
          <SfTableHeading>
            <SfTableHeader class="products__name">
              {{ $t('OrderHistory.Product') }}
            </SfTableHeader>
            <SfTableHeader>{{ $t('OrderHistory.Quantity') }}</SfTableHeader>
            <SfTableHeader>{{ $t('OrderHistory.Price') }}</SfTableHeader>
            <SfTableHeader v-if="returnOrder" />
          </SfTableHeading>
          <SfTableRow
            v-for="item of allItems"
            :key="item.id"
          >
            <SfTableData class="products__name">
              <nuxt-link
                :to="localePath(
                  orderGetters.getOrderItemLink(
                    currentOrder,
                    item.itemVariationId
                  )
                )
                "
              >
                {{ orderGetters.getItemName(item) }}
              </nuxt-link>
            </SfTableData>
            <SfTableData>{{ orderGetters.getItemQty(item) }}</SfTableData>
            <SfTableData>
              {{
                $n(orderGetters.getItemPrice(item), 'currency')
              }}
            </SfTableData>
            <SfTableData
              v-if="returnOrder"
              class="flex"
            >
              <div
                class="sf-quantity-selector flex justify-around"
                aria-label="Quantity"
              >
                <button
                  class="sf-button--pure sf-quantity-selector__button sf-button"
                  :aria-disabled="false"
                  :link="null"
                  type="button"
                  aria-label="button"
                  data-testid="decrease"
                  @click="decrease(item)"
                >
                  âˆ’
                </button>
                <span>{{ item.selectorQuantity }}</span>
                <button
                  class="sf-button--pure sf-quantity-selector__button sf-button"
                  :aria-disabled="false"
                  :link="null"
                  type="button"
                  aria-label="button"
                  data-testid="increase"
                  @click="increase(item)"
                >
                  +
                </button>
              </div>
            </SfTableData>
          </SfTableRow>
        </SfTable>
        <SfButton
          v-if="returnOrder"
          class="sf-button--full-width sf-c-light-primary-lighten"
          @click="makeReturnAction"
        >
          {{ $t('OrderHistory.Return items') }}
        </SfButton>
        <DocumentsList
          v-if="currentOrder.order.documents"
          class="mt-5"
          :access-key="currentOrder.order.accessKey"
          :documents="currentOrder.order.documents"
        />
      </div>
      <div v-else>
        <p class="message">
          {{ $t('OrderHistory.Details and order status') }}
        </p>
        <div
          v-if="totalOrders === 0"
          class="no-orders"
        >
          <p class="no-orders__title">
            {{ $t('OrderHistory.You currently have no orders') }}
          </p>
          <SfButton class="no-orders__button">
            {{ $t('OrderHistory.Start shopping') }}
          </SfButton>
        </div>
        <SfTable
          v-else
          class="orders"
        >
          <SfTableHeading>
            <SfTableHeader
              v-for="tableHeader in tableHeaders"
              :key="tableHeader"
            >
              {{ $t(tableHeader) }}
            </SfTableHeader>
            <SfTableHeader class="orders__element--right" />
          </SfTableHeading>
          <SfTableRow
            v-for="order in orders"
            :key="orderGetters.getId(order)"
          >
            <SfTableData v-e2e="'order-number'">
              {{ orderGetters.getId(order) }}
            </SfTableData>
            <SfTableData>{{ orderGetters.getDate(order) }}</SfTableData>
            <SfTableData>
              {{
                $n(orderGetters.getPrice(order), 'currency')
              }}
            </SfTableData>
            <SfTableData>
              <span :class="getStatusTextClass(order)">{{
                orderGetters.getStatus(order)
              }}</span>
            </SfTableData>
            <SfTableData class="orders__view orders__element--right">
              <SfButton
                class="sf-button--text"
                @click="setCurrentOrder(order)"
              >
                {{ $t('OrderHistory.View details') }}
              </SfButton>
              <SfButton
                :disabled="!orderGetters.isReturnable(order)"
                class="sf-button--text"
                @click="setCurrentOrder(order), (returnOrder = true)"
              >
                {{ $t('OrderHistory.Return items') }}
              </SfButton>
            </SfTableData>
          </SfTableRow>
        </SfTable>

        <LazyHydrate on-interaction>
          <SfPagination
            v-show="paginationGetters.getTotalPages(pagination) > 1"
            class="products__pagination desktop-only"
            :current="paginationGetters.getCurrentPage(pagination)"
            :total="paginationGetters.getTotalPages(pagination)"
            :visible="5"
          />
        </LazyHydrate>
        <p>{{ $t('OrderHistory.Total orders') }} - {{ totalOrders }}</p>
      </div>
    </SfTab>
  </SfTabs>
</template>

<script lang="js">
import {
  SfTabs,
  SfTable,
  SfButton,
  SfProperty,
  SfPagination
} from '@storefront-ui/vue';
import LazyHydrate from 'vue-lazy-hydration';
import { computed, ref, watch, getCurrentInstance, useContext, useRouter } from '@nuxtjs/composition-api';
import { useUserOrder, orderGetters, paginationGetters, useMakeReturn } from '@vue-storefront/plentymarkets';
import { AgnosticOrderStatus, onSSR } from '@vue-storefront/core';
import { useUiNotification } from '~/composables';
import DocumentsList from '~/components/DocumentsList.vue';
export default {
  name: 'PersonalDetails',
  components: {
    SfTabs,
    SfTable,
    SfButton,
    SfProperty,
    LazyHydrate,
    SfPagination,
    DocumentsList
  },
  setup() {
    const ctx = getCurrentInstance().root.proxy;
    const { query } = ctx.$router.currentRoute;
    const { orders: orderResult, search, loading } = useUserOrder();
    const { makeReturn, error } = useMakeReturn('make-return');
    const currentOrder = ref(null);
    const pagination = computed(() => orderGetters.getPagination(orderResult.value));
    const orders = computed(() => orderResult.value?.data?.entries);
    const returnOrder = false;
    const allItems = ref([]);
    const { send } = useUiNotification();
    const { app } = useContext();
    const router = useRouter();

    watch(currentOrder, async (selectedOrder) => {
      allItems.value = orderGetters.getItems(selectedOrder).map((item) => {
        return {
          ...item,
          selectorQuantity: 0
        };
      });
    }, { deep: true });

    const increase = (item) => {
      if (item.selectorQuantity < orderGetters.getItemQty(item)) {
        item.selectorQuantity++;
      }
    };

    const decrease = (item) => {
      if (item.selectorQuantity > 0) {
        item.selectorQuantity--;
      }
    };

    const makeReturnAction = async () => {

      const returnParams = {
        orderId: currentOrder.value.order.id,
        orderAccessKey: currentOrder.value.order.accessKey,
        returnNote: '',
        variationIds: []
      };

      allItems.value.forEach(item => {
        if (item.selectorQuantity > 0) {
          returnParams.variationIds.push({
            quantity: item.selectorQuantity,
            id: orderGetters.getItemVariationId(item)
          });
        }
      });

      await makeReturn(returnParams);
      if (error.value) {
        send({ message: app.i18n.t('OrderReturn.Error'), type: 'danger', persist: true });
      } else {
        send({ message: app.i18n.t('OrderReturn.Success'), type: 'success' });
        router.push(app.i18n.t('MyAccount.Order returns'));
      }
      currentOrder.value = null;
    };

    onSSR(async () => {
      await search(query);
    });

    const tableHeaders = [
      'OrderHistory.Order ID',
      'OrderHistory.Order date',
      'OrderHistory.Amount',
      'OrderHistory.Status'
    ];

    const setCurrentOrder = (order) => {
      currentOrder.value = order;
    };

    const updateQuantity = (item, quantity) => {
      item.selectorQuantity = quantity;
    };

    const getStatusTextClass = (order) => {
      const status = orderGetters.getStatus(order);

      switch (status) {
        case AgnosticOrderStatus.Open:
          return 'text-warning';
        case AgnosticOrderStatus.Complete:
          return 'text-success';
        default:
          return '';
      }
    };

    return {
      tableHeaders,
      orders,
      pagination,
      loading,
      paginationGetters,
      totalOrders: computed(() => orderGetters.getOrdersTotal(orderResult.value)),
      orderGetters,
      currentOrder,
      returnOrder,
      allItems,
      getStatusTextClass,
      updateQuantity,
      setCurrentOrder,
      makeReturnAction,
      increase,
      decrease
    };

  }
};
</script>

<style lang="scss" scoped>
.no-orders {
  &__title {
    margin: 0 0 var(--spacer-lg) 0;
    font: var(--font-weight--normal) var(--font-size--base) / 1.6 var(--font-family--primary);
  }

  &__button {
    --button-width: 100%;

    @include for-desktop {
      --button-width: 17, 5rem;
    }
  }
}

.orders {
  @include for-desktop {
    &__element {
      &--right {
        --table-column-flex: 1;
        text-align: right;
      }
    }
  }
}

.orders {
  @include for-desktop {
    &__element {
      &--right {
        --table-column-flex: 1;
        text-align: right;
      }
    }
  }
}

.all-orders {
  --button-padding: var(--spacer-base) 0;
}

.message {
  margin: 0 0 var(--spacer-xl) 0;
  font: var(--font-weight--light) var(--font-size--base) / 1.6 var(--font-family--primary);

  &__link {
    color: var(--c-primary);
    font-weight: var(--font-weight--medium);
    font-family: var(--font-family--primary);
    font-size: var(--font-size--base);
    text-decoration: none;

    &:hover {
      color: var(--c-text);
    }
  }
}

.product {
  &__properties {
    margin: var(--spacer-xl) 0 0 0;
  }

  &__property,
  &__action {
    font-size: var(--font-size--sm);
  }

  &__action {
    color: var(--c-gray-variant);
    font-size: var(--font-size--sm);
    margin: 0 0 var(--spacer-sm) 0;

    &:last-child {
      margin: 0;
    }
  }

  &__qty {
    color: var(--c-text);
  }
}

.products {
  --table-column-flex: 1;

  &__name {
    margin-right: var(--spacer-sm);

    @include for-desktop {
      --table-column-flex: 2;
    }
  }
}

.product {
  &__properties {
    margin: var(--spacer-xl) 0 0 0;
  }

  &__property,
  &__action {
    font-size: var(--font-size--sm);
  }

  &__action {
    color: var(--c-gray-variant);
    font-size: var(--font-size--sm);
    margin: 0 0 var(--spacer-sm) 0;

    &:last-child {
      margin: 0;
    }
  }

  &__qty {
    color: var(--c-text);
  }
}

.products {
  --table-column-flex: 1;

  &__name {
    margin-right: var(--spacer-sm);

    @include for-desktop {
      --table-column-flex: 2;
    }
  }
}

.highlighted {
  box-sizing: border-box;
  width: 100%;
  background-color: var(--c-light);
  padding: var(--spacer-sm);
  --property-value-font-size: var(--font-size--base);
  --property-name-font-size: var(--font-size--base);

  &:last-child {
    margin-bottom: 0;
  }

  ::v-deep .sf-property__name {
    white-space: nowrap;
  }

  ::v-deep .sf-property__value {
    text-align: right;
  }

  &--total {
    margin-bottom: var(--spacer-sm);
  }

  @include for-desktop {
    padding: var(--spacer-xl);
    --property-name-font-size: var(--font-size--lg);
    --property-name-font-weight: var(--font-weight--medium);
    --property-value-font-size: var(--font-size--lg);
    --property-value-font-weight: var(--font-weight--semibold);
  }
}
</style>
